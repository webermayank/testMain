name: Detect JSDoc Changes & Create Issue

on:
  push:
    branches:
      - main
    paths:
      - 'src/**' # Detect changes in all files inside src/

jobs:
  detect-and-create-issue:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm install

      - name: Extract and Compare JSDoc
        run: node ./scripts/compare-docs.js

      - name: Read changes JSON
        id: read-changes
        run: |
          if [ -s docs_changes.json ]; then
            echo "Changes detected!"
            echo "CHANGES=$(jq -c . docs_changes.json)" >> "$GITHUB_ENV"
          else
            echo "No changes detected."
            echo "CHANGES=[]" >> "$GITHUB_ENV"
          fi

      - name: Debug Output
        run: |
          echo "Detected Changes: $CHANGES"
        env:
          CHANGES: ${{ env.CHANGES }}

      - name: Create Issue in testWebsite
        if: steps.read-changes.outputs.changes != '[]'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.WEBSITE_REPO_TOKEN }}
          script: |
            const changes = JSON.parse(`${{ steps.read-changes.outputs.changes }}`);
            const issueBody = changes.map(change => 
              `- **File**: \`${change.file}\`\n  - **Line**: ${change.line}\n  - **Old**: ${change.old}\n  - **New**: ${change.new}`
            ).join("\n\n");
            
            changes.forEach((change, index) => {
              issueBody += `### Change ${index + 1}\n`;
              issueBody += `ðŸ“„ **File:** ${change.file}\n`;
              issueBody += `ðŸ”¢ **Line Number:** ${change.line}\n`;
              issueBody += `ðŸ“ **Old:** ${change.old || "N/A"}\n`;
              issueBody += `ðŸ†• **New:** ${change.new || "N/A"}\n\n`;
            });

            issueBody += "ðŸ“Œ **Translation needed in:**\n";
            const languages = ["en", "es", "fr", "de"];
            languages.forEach(lang => {
              issueBody += `- [ ] \`reference/${lang}/${folderPath}/${path.basename(change.file)}.mdx\`\n`;
            });
            await github.rest.issues.create({
              owner: "webermayank",
              repo: "testWebsite",
              title: ` ${Change.file} updated in P5.js â€“ Translation Needed`,
              body: `The following documentation updates require translation:\n\n${issueBody}\n\n[View Merged PR](https://github.com/webermayank/TestMain/commit/${{ github.sha }})`
            });
